!function(a,b,c){function d(b,e){this.element=b,this.$element=a(b),this.$itemList=a(d.MENU_TEMPLATE),this.currentToken=c,this.options=a.extend({},g,e),a.isArray(this.options.token)||(this.options.token=[this.options.token]),this.reset(),this._defaults=g,this._name=f;var h=this.options.token.join("");this.expression=new RegExp("(^|\\b|\\s)(["+h+"])([\\w.]*)$"),this.cleanupHandle=null,this.init()}var e=function(a,b){a.text(b.val)},f="sew",g={token:"@",elementFactory:e,values:[],unique:!1,repeat:!0,onFilterChanged:c,preload:!1};d.MENU_TEMPLATE="<div class='-sew-list-container' style='display: none; position: absolute;'><ul class='-sew-list'></ul></div>",d.ITEM_TEMPLATE='<li class="-sew-list-item"></li>',d.KEYS=[40,38,13,27,9],d.prototype.init=function(){this.options.values.length<1&&!this.options.onFilterChanged||(this.options.preload&&this.options.onFilterChanged&&this.options.onFilterChanged(this),this.$element.unbind("keyup.jquery-sew").bind("keyup.jquery-sew",a.proxy(this.onKeyUp,this)).unbind("keydown.jquery-sew").bind("keydown.jquery-sew",a.proxy(this.onKeyDown,this)).unbind("keypress.jquery-sew").bind("keypress.jquery-sew",a.proxy(this.onKeyPress,this)).unbind("focus.jquery-sew").bind("focus.jquery-sew",a.proxy(this.renderElements,this,this.options.values)).unbind("blur.jquery-sew").bind("blur.jquery-sew",a.proxy(this.remove,this)))},d.prototype.reset=function(){this.options.unique&&(this.options.values=d.getUniqueElements(this.options.values)),this.index=0,this.matched=!1,this.dontFilter=!1,this.lastFilter=c,this.filtered=this.options.values.slice(0)},d.prototype.setValues=function(a){this.options.values=a;var b=this.$itemList.is(":visible");if(this.reset(),a.length>0){b||this.displayList();var c=this.lastFilter;c||(c=""),this.lastFilter="\n",this.filterList(c)}else this.hideList()},d.prototype.next=function(){this.index=(this.index+1)%this.filtered.length,this.hightlightItem()},d.prototype.prev=function(){this.index=(this.index+this.filtered.length-1)%this.filtered.length,this.hightlightItem()},d.prototype.select=function(){this.replace(this.filtered[this.index].val),this.$element.trigger("mention-selected",this.filtered[this.index]),this.hideList()},d.prototype.remove=function(){this.$itemList.fadeOut("slow"),this.cleanupHandle=b.setTimeout(a.proxy(function(){this.$itemList.remove()},this),1e3)},d.prototype.replace=function(a){var b=this.$element.getCursorPosition(),c=this.getText(),d=c.substring(0,b);d=d.replace(this.expression,"$1$2"+a);var e=c.substring(b,c.length),f=e.match(/^\s/)?"":" ",g=d+f+e;this.setText(g)},d.prototype.hightlightItem=function(){if(0!==this.filtered.length){this.$itemList.find(".-sew-list-item").removeClass("selected");var a=this.$itemList.find(".-sew-list-item").parent(),b=this.filtered[this.index].element.addClass("selected"),c=b.position().top;a.scrollTop(a.scrollTop()+c)}},d.prototype.renderElements=function(c){b.sew=this,a("body").append(this.$itemList);var e=this.$itemList.find("ul").empty();c.forEach(a.proxy(function(b,c){var f=a(d.ITEM_TEMPLATE);this.options.elementFactory(f,b,this.currentToken),b.element=f.appendTo(e).bind("click",a.proxy(this.onItemClick,this,b)).bind("mouseover",a.proxy(this.onItemHover,this,c))},this)),this.index=0,this.hightlightItem()},d.prototype.displayList=function(){if(this.filtered.length){this.$itemList.show();var a=this.$element,b=this.$element.offset(),c=a.getCaretPosition();this.$itemList.css({left:b.left+c.left,top:b.top+c.top})}},d.prototype.hideList=function(){this.$itemList.hide(),this.reset()},d.prototype.filterList=function(b){if(b!=this.lastFilter){this.lastFilter=b,this.$itemList.find(".-sew-list-item").remove();var c=this.options.values,d=this.filtered=c.filter(a.proxy(function(a){var c=new RegExp("\\W*"+this.options.token+a.val+"(\\W|$)");return!this.options.repeat&&this.getText().match(c)?!1:""===b||a.val.toLowerCase().indexOf(b.toLowerCase())>=0||(a.meta||"").toLowerCase().indexOf(b.toLowerCase())>=0},this));d.length?(this.renderElements(d),this.$itemList.show()):this.hideList()}},d.getUniqueElements=function(a){var b=[];return a.forEach(function(a){var c=b.map(function(a){return a.val}).indexOf(a.val)>=0;c||b.push(a)}),b},d.prototype.getText=function(){return this.$element.val()||this.$element.text()},d.prototype.setText=function(a){this.$element.is("input,textarea")?this.$element.val(a):this.$element.html(a)},d.prototype.onKeyUp=function(a){if(!(d.KEYS.indexOf(a.keyCode)>-1)){var b=this.$element.getCursorPosition(),c=this.getText().substring(0,b),e=c.match(this.expression);return e?(this.currentToken=e[2],this.currentToken!=e[2]&&this.currentToken&&(this.currentToken=e[2],this.options.onFilterChanged&&(this.options.values=[],this.reset())),this.options.onFilterChanged&&this.options.onFilterChanged(this,e[3],e[2]),this.matched||(this.displayList(),this.lastFilter="\n",this.matched=!0),this.dontFilter||this.filterList(e[3]),void 0):(this.matched=!1,this.dontFilter=!1,this.hideList(),void 0)}},d.prototype.onKeyDown=function(a){var b=this.$itemList.is(":visible");if(b&&!(d.KEYS.indexOf(a.keyCode)<0)){switch(a.keyCode){case 9:case 13:this.select();break;case 40:this.next();break;case 38:this.prev();break;case 27:this.$itemList.hide(),this.dontFilter=!0}a.preventDefault()}},d.prototype.onKeyPress=function(a){switch(a.keyCode){case 13:this.$itemList.is(":visible")&&(a.preventDefault(),this.hideList())}},d.prototype.onItemClick=function(a){this.cleanupHandle&&b.clearTimeout(this.cleanupHandle),this.replace(a.val),this.$element.trigger("mention-selected",this.filtered[this.index]),this.hideList()},d.prototype.onItemHover=function(a){this.index=a,this.hightlightItem()},a.fn[f]=function(b){return this.each(function(){a.data(this,"plugin_"+f)||a.data(this,"plugin_"+f,new d(this,b))})}}(jQuery,window);